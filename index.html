<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Weather - Last Day</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Custom CSS -->
    <style>
        #map { height: 600px; width: 100%; }
        body { font-family: 'Futura', sans-serif; text-align: center; padding: 20px; }
        h1 { color: #333; }
        #table-container { margin-top: 20px; padding: 0 10px; }
        #weather-table { width: 100%; border-collapse: collapse; }
        #weather-table th, #weather-table td { border: 1px solid #ddd; padding: 8px; }
        #weather-table th { background-color: #f4f4f4; text-align: left; }
        #weather-table td { text-align: center; }
        .custom-icon {
            font-family: 'Futura', sans-serif;
        }
    </style>
</head>
<body>
    <h1 id="title">Weather in Sweden - Last Day</h1>
    <p id="subtitle">Weather in Sweden - September 6th, 2024</p>
    <p>Click on each location on the map to see the last day's weather data.</p>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Table Container -->
    <div id="table-container">
        <table id="weather-table">
            <thead>
                <tr>
                    <th>Station</th>
                    <th>Max Temp (°C)</th>
                    <th>Min Temp (°C)</th>
                    <th>Avg Temp (°C)</th>
                    <th>Precipitation (mm)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- PapaParse to load CSV data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        var map = L.map('map', {
            center: [63.0, 16.0],
            zoom: 5,
            scrollWheelZoom: false,
            dragging: false,
            touchZoom: false,
            doubleClickZoom: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        const parameterMapping = {
            19: "min temperature",
            20: "max temperature",
            2: "avg temperature",
            5: "precipitation"
        };

        function loadCsvData() {
            Papa.parse('https://raw.githubusercontent.com/pablo-ferro/SwedishWeather/main/all_data.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    console.log('CSV Data:', results.data);
                    plotMarkers(results.data);
                },
                error: function(error) {
                    console.error('Error loading CSV:', error);
                }
            });
        }

function interpolateColor(value, min, max) {
    let ratio = (value - min) / (max - min);
    let r, g, b;

    if (ratio <= 0.5) {
        // Interpolate from soft blue to white
        r = Math.round(100 + ratio * (255 - 100));  // From blue to white
        g = Math.round(150 + ratio * (255 - 150));  // From blue to white
        b = Math.round(255 + ratio * (255 - 255));  // From blue to white
    } else {
        // Interpolate from white to soft red
        r = Math.round(255 + (ratio - 0.5) * (255 - 255));  // From white to red
        g = Math.round(255 + (ratio - 0.5) * (100 - 255));  // From white to red
        b = Math.round(255 + (ratio - 0.5) * (100 - 255));  // From white to red
    }

    return `rgb(${r}, ${g}, ${b})`;
}

        function plotMarkers(data) {
            let stations = {};
            let avgTemps = [];
            let refDate = "";

            data.forEach(function(row) {
                var stationId = row.station;
                var parameter = parseInt(row.parameter);
                var lat = row.latitude ? parseFloat(row.latitude.trim()) : NaN;
                var lon = row.longitude ? parseFloat(row.longitude.trim()) : NaN;

                if (isNaN(lat) || isNaN(lon)) {
                    console.warn(`Invalid lat/lon for station ${stationId}: (${lat}, ${lon})`);
                    return;
                }

                if (!stations[stationId]) {
                    stations[stationId] = {
                        name: row.name,
                        lat: lat,
                        lon: lon,
                        data: {}
                    };
                }

                var variable = parameterMapping[parameter];
                if (variable) {
                    stations[stationId].data[variable] = row.value;
                }

                if (parameter === 2) {
                    avgTemps.push(parseFloat(row.value));
                    if (!refDate) refDate = row.ref;
                }
            });

            let minTemp = Math.min(...avgTemps);
            let maxTemp = Math.max(...avgTemps);

            let bounds = [];
            Object.keys(stations).forEach(function(stationId) {
                var station = stations[stationId];
                var avgTemp = parseFloat(station.data["avg temperature"]);
                var color = interpolateColor(avgTemp, minTemp, maxTemp);

                var marker = L.marker([station.lat, station.lon], {
                    icon: L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background-color: ${color}; color: black; text-align: center; line-height: 20px; width: 20px; height: 20px; border-radius: 50%; font-size: 10px;">•</div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);

                marker.bindPopup(`
                    <strong>${station.name}</strong><br>
                    Max Temp: ${station.data["max temperature"] || "N/A"} °C<br>
                    Min Temp: ${station.data["min temperature"] || "N/A"} °C<br>
                    Avg Temp: ${station.data["avg temperature"] || "N/A"} °C<br>
                    Precipitation: ${station.data["precipitation"] || "N/A"} mm
                `);

                bounds.push([station.lat, station.lon]);
            });

            if (bounds.length > 0) {
                map.fitBounds(bounds);
            }

            document.getElementById('title').innerText = `Weather in Sweden - ${refDate}`;
            document.getElementById('subtitle').innerText = `Vädret i Sverige - ${refDate}`;
            
            updateTable(stations);
        }

        function updateTable(stations) {
            var tableBody = document.querySelector('#weather-table tbody');
            tableBody.innerHTML = '';

            Object.keys(stations).forEach(function(stationId) {
                var station = stations[stationId];
                var row = document.createElement('tr');

                row.innerHTML = `
                    <td>${station.name}</td>
                    <td>${station.data["max temperature"] || "N/A"}</td>
                    <td>${station.data["min temperature"] || "N/A"}</td>
                    <td>${station.data["avg temperature"] || "N/A"}</td>
                    <td>${station.data["precipitation"] || "N/A"}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        loadCsvData();
    </script>
</body>
</html>
