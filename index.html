<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweden Weather - Last Day</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <!-- Custom CSS -->
    <style>
        #map { height: 600px; width: 100%; }
        body { font-family: 'Futura', sans-serif; text-align: center; padding: 20px; }
        h1 { color: #333; }
        #table-container { margin-top: 20px; padding: 0 10px; }
        #weather-table { width: 100%; border-collapse: collapse; }
        #weather-table th, #weather-table td { border: 1px solid #ddd; padding: 8px; }
        #weather-table th { background-color: #f4f4f4; text-align: left; }
        #weather-table td { text-align: center; }
        .custom-icon {
            font-family: 'Futura', sans-serif;
        }
    </style>
</head>
<body>
    <h1>Weather in Sweden - Last Day</h1>
    <p>Click on each location on the map to see the last day's weather data.</p>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Table Container -->
    <div id="table-container">
        <table id="weather-table">
            <thead>
                <tr>
                    <th>Station</th>
                    <th>Max Temp (°C)</th>
                    <th>Min Temp (°C)</th>
                    <th>Avg Temp (°C)</th>
                    <th>Precipitation (mm)</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be inserted here -->
            </tbody>
        </table>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- PapaParse to load CSV data -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script>
        // Initialize the map centered on Sweden with zoom restrictions
        var map = L.map('map', {
            center: [63.0, 16.0],
            zoom: 5,
            minZoom: 5,
            maxZoom: 8 // Restrict maximum zoom level
        });

        // Set up the map tiles (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Mapping of parameter codes to weather variables
        const parameterMapping = {
            19: "min temperature",
            20: "max temperature",
            2: "avg temperature",
            5: "precipitation"
        };

        // Function to load CSV data
        function loadCsvData() {
            Papa.parse('https://raw.githubusercontent.com/pablo-ferro/SwedishWeather/main/all_data.csv', {
                download: true,
                header: true,
                complete: function(results) {
                    console.log('CSV Data:', results.data);  // Check if data is loaded
                    plotMarkers(results.data);
                },
                error: function(error) {
                    console.error('Error loading CSV:', error);  // Log any errors
                }
            });
        }

        // Function to get color based on average temperature
        function getColor(temp) {
            if (temp <= 0) return '#add8e6'; // Soft Blue for low temperatures
            if (temp >= 20) return '#f08080'; // Soft Red for high temperatures
            return '#ffffff'; // White for middle values
        }

        // Function to plot markers on the map and update the table
        function plotMarkers(data) {
            var stations = {};
            var avgTemps = [];

            data.forEach(function(row) {
                var stationId = row.station;
                var parameter = parseInt(row.parameter);
                var lat = row.latitude ? parseFloat(row.latitude.trim()) : NaN;  // Ensure lat is a number
                var lon = row.longitude ? parseFloat(row.longitude.trim()) : NaN;  // Ensure lon is a number

                // Log lat and lon values to debug
                console.log(`Station ${stationId} - Lat: ${lat}, Lon: ${lon}`);

                if (isNaN(lat) || isNaN(lon)) {
                    console.warn(`Invalid lat/lon for station ${stationId}: (${lat}, ${lon})`);
                    return; // Skip this row if lat/lon is invalid
                }

                if (!stations[stationId]) {
                    stations[stationId] = {
                        name: row.name,
                        lat: lat,
                        lon: lon,
                        data: {}
                    };
                }
                
                var variable = parameterMapping[parameter];
                if (variable) {
                    stations[stationId].data[variable] = row.value;
                }
            });

            // Extract average temperatures for color scaling
            Object.keys(stations).forEach(function(stationId) {
                var station = stations[stationId];
                var avgTemp = parseFloat(station.data["avg temperature"]);
                if (!isNaN(avgTemp)) {
                    avgTemps.push(avgTemp);
                }
            });

            // Determine min and max average temperatures
            var minTemp = Math.min(...avgTemps);
            var maxTemp = Math.max(...avgTemps);

            // Plot markers on the map
            Object.keys(stations).forEach(function(stationId) {
                var station = stations[stationId];
                var avgTemp = parseFloat(station.data["avg temperature"]);
                var color = getColor(avgTemp);

                var marker = L.marker([station.lat, station.lon], {
                    icon: L.divIcon({
                        className: 'custom-icon',
                        html: `<div style="background-color: ${color}; color: black; text-align: center; line-height: 20px; width: 20px; height: 20px; border-radius: 50%; font-size: 10px;">•</div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(map);

                var weatherInfo = `
                    <strong>${station.name}</strong><br>
                    Max Temp: ${station.data["max temperature"] || "N/A"} °C<br>
                    Min Temp: ${station.data["min temperature"] || "N/A"} °C<br>
                    Avg Temp: ${station.data["avg temperature"] || "N/A"} °C<br>
                    Precipitation: ${station.data["precipitation"] || "N/A"} mm
                `;
                marker.bindPopup(weatherInfo);
            });

            // Update the table
            updateTable(stations);
        }

        // Function to update the table with weather data
        function updateTable(stations) {
            var tableBody = document.querySelector('#weather-table tbody');
            tableBody.innerHTML = ''; // Clear existing rows

            Object.keys(stations).forEach(function(stationId) {
                var station = stations[stationId];
                var row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${station.name}</td>
                    <td>${station.data["max temperature"] || "N/A"}</td>
                    <td>${station.data["min temperature"] || "N/A"}</td>
                    <td>${station.data["avg temperature"] || "N/A"}</td>
                    <td>${station.data["precipitation"] || "N/A"}</td>
                `;

                tableBody.appendChild(row);
            });
        }

        // Load the CSV data when the page is loaded
        loadCsvData();
    </script>
</body>
</html>
